# Delivery Plan – NeoForge Next Epics (Execution-Ready)

This plan captures the missing details and the exact work remaining to complete the epics underway and to hand off cleanly.

## Scope Covered So Far
- DB-backed persistence for `projects`, `support_tickets`, `community_posts`, `status_events`, and `idempotency_keys`.
- Endpoints migrated from in-memory:
  - Projects: list/get/create/patch/delete
  - Support tickets: create/list/patch
  - Community posts: create/list
  - Status: create/list events; compute overall and per-service status
- Idempotency:
  - Endpoint-level idempotency for create (projects, support, community) and patch (projects)
  - Central helper `IdempotencyManager` for precheck/store and TTL cleanup function
- Pagination:
  - `PaginatedResponse { items, total, page, page_size, pages }` used across list endpoints
- Caching:
  - ETag for `GET /api/v1/projects/{id}` and project list
  - ETag added for support/community list responses
- Security/Observability support:
  - Threat & rate-limit Prometheus counters
  - CSP report-only endpoint; Report-To header in non-prod
- Frontend integration:
  - Dynamic API base URL and idempotency keys added to `api.js`
  - Router consolidated; PWA offline sync implemented

## Remaining Tasks (Finish Epic 1 + operationalize)

### 1) Apply DB Migrations in Runtime
- [ ] Free local port 5432 or update compose mapping
- [ ] Apply migrations: `docker compose run --rm api alembic upgrade head`
  - Contains `user_sessions` table + indices
  - Indices present/expected:
    - user_sessions: user_id (non-unique), hashed_refresh_token (unique), created_at, expires_at, revoked_at
    - status_events: service_id, status, created_at (non-unique; ensure desc order in queries)
    - idempotency_keys: key (unique)

### 2) Tests (backend)
- [ ] CRUD & pagination integration tests for `projects`, `support_tickets`, `community_posts` (extend boundary cases: page=1, last page, overflows)
- [ ] Idempotency tests (duplicate POST/PATCH returning identical payloads; verify 201->200 semantics on replay)
- [ ] Status events tests – compute overall/per-service (operational/degraded from latest events)
- [x] Auth sessions list/revoke tests (slice for Epic 2)

### 3) Idempotency Middleware & TTL Cleanup
- [x] Convert support/community endpoints to use `IdempotencyManager`
- [x] Add periodic TTL cleanup job using `cleanup_idempotency_keys()` (app startup task)
- [ ] Add a smoke test that verifies expired keys are removed after TTL (unit/integration)

### 4) Caching
- [x] ETag on support/community list
- [ ] Consider `Cache-Control` headers for list endpoints (low TTL; dev only)

### 5) CI/CD
- [x] Add workflow step to run: `make setup && make test && make smoke`
- [ ] Ensure coverage is generated by backend test job (either switch Makefile test target to coverage or add pytest --cov in workflow)
- [x] Upload coverage and minimal artifacts (logs/reports)
- [x] Frontend unit sharding runs non-watch
- [x] Fix Makefile tab separators
- [x] Restrict pre-commit gates to PRs & Node 20
- [ ] Consider ESLint scope/ignore patterns to exclude playground and heavy tests from PR gates
- [ ] Tune pre-push hook to ignore credential-like strings in `backend/tests/**` and `docs/**`

### 6) Documentation
- [ ] API semantics: pagination, idempotency, ETag usage (If-None-Match), auth sessions (list/revoke)
- [ ] Dev guide: migrations + smoke, backend test commands, Docker notes (ports)
- [ ] CSP reporting: endpoint usage, troubleshooting patterns, aggregation guidance

## Epic 2 – Security & Account Lifecycle (Execution Details)

### A) Refresh token sessions (foundation done)
- Models/CRUD: `UserSession` exists; opaque refresh tokens issued at `POST /api/v1/auth/token`; `POST /api/v1/auth/refresh` exchanges refresh→access.
- Remaining work:
  - [x] Session listing for current user: `GET /api/v1/auth/sessions`
    - Query `UserSession` by `user_id`, default sort `created_at desc`, pagination via standard params
    - Response: `PaginatedResponse[SessionOut]` (id, created_at, last_used_at, user_agent, ip, expires_at, is_current)
  - [x] Session revocation: `POST /api/v1/auth/sessions/{session_id}/revoke`
    - Sets `revoked_at`; denies subsequent refresh; owner-only
  - [ ] Revoke all except current: `POST /api/v1/auth/sessions/revoke-others` (optional stretch)
  - [ ] Tests: `backend/tests/api/test_auth_sessions.py`
    - Validate pagination metadata (total/pages/page_size)
    - Ensure sensitive data redaction (no raw refresh token exposure)
    - Ownership enforcement on revoke (404 for others)

### B) Rate limiting response headers
- Add standard headers on limited routes (especially login):
  - `X-RateLimit-Limit`, `X-RateLimit-Remaining`, `X-RateLimit-Reset` (epoch seconds)
- Implementation point: `backend/app/api/middleware/security.py`
  - After computing the allowance decision, attach headers to the response
 - [x] Tests: hit the login route repeatedly, assert headers decrement and 429 contains headers
 - [x] Tests: hit the login route repeatedly, assert headers decrement and 429 contains headers

### C) CSP reporting docs
- Document CSP report endpoint and sample `Content-Security-Policy-Report-Only` and `Report-To` values
- Add troubleshooting for common violations and how to aggregate in logs

### D) Indices and DB performance
- Ensure indices exist for:
  - `status_events (service_id, status, created_at)`
  - `idempotency_keys (key)` unique index
  - `user_sessions (user_id, hashed_refresh_token unique, created_at, expires_at, revoked_at)`
- If missing, generate and apply a migration (zero-downtime safe)

### E) Affecting Pre-commit Quality Gates (PR-only)
- ESLint currently flags numerous issues under `frontend/src/playground/**` and advanced tests.
- Options (pick one):
  - Relax PR gate to run `npm run lint` only on `src/components/**`, `src/services/**`, `src/pages/**`
  - Add `.eslintignore` entries for `src/playground/**`, `src/test/advanced/**`, `src/test/visual/**` (kept in main lint but not PR gate)
  - Introduce a separate slower, non-blocking workflow that lints full tree and posts a report

## Acceptance Criteria – Epic 2 (phase slice)
- [x] Users can view and revoke refresh sessions via API (endpoint implemented; test added)
- [x] Login route exposes rate limit headers; behavior tested
- [ ] CSP reporting documented and endpoint verified via smoke
- [ ] DB indices verified or added for hot paths

## Execution Playbook (Next Engineer)

1) Apply DB migrations and smoke tests
- docker compose run --rm api alembic upgrade head
- make smoke (wait for healthy)

2) Ensure backend tests generate coverage in CI
- Option A: modify Makefile test target to include coverage flags
- Option B: override test step in workflow to run `docker compose run --rm api_test pytest --cov=app --cov-report=xml:coverage.xml`

3) Add missing backend tests (pagination/idempotency/status)
- Place under `backend/tests/api/` and use `conftest.py` fixtures

4) Docs
- Update API semantics and CSP docs; ensure examples are runnable

5) Pre-push hook tuning
- Adjust patterns to ignore tests and docs; keep protection for non-test code paths

6) Optional stretch
- Revoke all sessions except current; add endpoint + test
- Add `Cache-Control` headers for list endpoints (short TTL in dev)

## Operational Steps to Close This Phase
1) Implement and test sessions list/revoke
2) Add RL headers; extend tests
3) Update docs (API semantics + CSP + Dev steps)
4) Tidy CI lint scope for PRs if too noisy; keep a non-blocking full lint report
5) Ensure smoke passes and CI green

## Future Epics (High-Level)

### Epic 2: Security & Account Lifecycle
- Refresh-token rotation; session/device management; optional 2FA
- Audit log model and hooks for sensitive flows
- Strong rate-limit tiers on auth/email

### Epic 3: Observability & SLOs
- OpenTelemetry tracing (FastAPI + SQLAlchemy)
- Grafana dashboards and alert rules (latency, errors, RL violations, threat blocks)

### Epic 4: Frontend Type Safety, A11y, PWA UX
- Incremental TS migration; openapi-generated types for `apiService`
- A11y fixes and automated CI checks
- Conflict-resolution UX for offline replay failures

## Operational Checklist to Call Epic 1 “Done”
- [ ] Migrations applied in dev/runtime and verified
- [ ] All new backend tests pass in CI
- [ ] Project/support/community endpoints verified with pagination and ETag
- [ ] Idempotency works reliably under load; TTL cleanup scheduled
- [ ] Docs updated (API + Dev)
- [ ] CI smoke passes consistently
