name: Accessibility Testing

on:
  push:
    branches: [main, develop]
    paths:
      - 'frontend/**'
      - '.github/workflows/accessibility.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'frontend/**'
      - '.github/workflows/accessibility.yml'

jobs:
  accessibility-tests:
    name: Accessibility Testing with axe-core
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build application
        run: bun run build

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run accessibility tests
        run: bun run test:a11y

      - name: Run component-level accessibility tests
        run: bun run test:a11y:components

      - name: Upload accessibility reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: accessibility-reports
          path: |
            frontend/playwright-report/
            frontend/test-results/
            frontend/artifacts/
          retention-days: 7

      - name: Comment PR with accessibility results
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Try to read accessibility violations report
            let reportContent = 'Accessibility tests failed. Please check the artifacts for detailed results.';
            
            try {
              const reportPath = path.join('frontend', 'artifacts', 'accessibilityReport.html');
              if (fs.existsSync(reportPath)) {
                reportContent = `
                ## ♿ Accessibility Test Results
                
                ❌ Accessibility violations found. Please review the detailed report in the artifacts.
                
                ### Quick fixes needed:
                - Check touch target sizes (minimum 44px)
                - Verify color contrast ratios (minimum 4.5:1 for text)
                - Add proper ARIA labels where missing
                - Ensure keyboard navigation works for all interactive elements
                
                **View the full report in the workflow artifacts.**
                `;
              }
            } catch (error) {
              console.log('Could not read accessibility report:', error.message);
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: reportContent
            });

  accessibility-audit:
    name: Full Page Accessibility Audit
    runs-on: ubuntu-latest
    needs: accessibility-tests
    if: github.event_name == 'pull_request'
    
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build application
        run: bun run build

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run full page audit
        run: bun run test:a11y:audit

      - name: Generate accessibility summary
        run: |
          echo "## 🔍 Accessibility Audit Summary" > accessibility-summary.md
          echo "" >> accessibility-summary.md
          
          # Count violations from reports if they exist
          if [ -f "artifacts/accessibilityReport.html" ]; then
            echo "✅ Accessibility audit completed" >> accessibility-summary.md
            echo "📊 View detailed results in workflow artifacts" >> accessibility-summary.md
          else
            echo "❌ Accessibility audit failed to generate report" >> accessibility-summary.md
          fi
          
          echo "" >> accessibility-summary.md
          echo "### Key Areas Checked:" >> accessibility-summary.md
          echo "- Color contrast compliance (WCAG AA)" >> accessibility-summary.md
          echo "- Touch target accessibility (44px minimum)" >> accessibility-summary.md
          echo "- Keyboard navigation support" >> accessibility-summary.md
          echo "- Screen reader compatibility (ARIA)" >> accessibility-summary.md
          echo "- Form accessibility" >> accessibility-summary.md
          echo "- Heading structure and landmarks" >> accessibility-summary.md

      - name: Upload audit artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: accessibility-audit
          path: |
            frontend/artifacts/
            frontend/accessibility-summary.md
          retention-days: 7